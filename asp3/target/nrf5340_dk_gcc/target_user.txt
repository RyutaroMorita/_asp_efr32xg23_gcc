
		TOPPERS/ASP3カーネル
		nRF5340-DK依存部 ユーザーズマニュアル

		対応バージョン: Release 3.7.0
		最終更新: 2023年4月1日

このドキュメントは，TOPPERS/ASP3カーネルのnRF5340-DKターゲット依存部
を使用するために必要な事項を説明するものである．

----------------------------------------------------------------------
 TOPPERS/ASP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     Advanced Standard Profile Kernel

 Copyright (C) 2008-2019 by Embedded and Real-Time Systems Laboratory
             Graduate School of Information Science, Nagoya Univ., JAPAN
 
 上記著作権者は，以下の(1)〜(4)の条件を満たす場合に限り，本ソフトウェ
 ア（本ソフトウェアを改変したものを含む．以下同じ）を使用・複製・改
 変・再配布（以下，利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアを，ライブラリ形式など，他のソフトウェア開発に使
     用できる形で再配布する場合には，再配布に伴うドキュメント（利用
     者マニュアルなど）に，上記の著作権表示，この利用条件および下記
     の無保証規定を掲載すること．
 (3) 本ソフトウェアを，機器に組み込むなど，他のソフトウェア開発に使
     用できない形で再配布する場合には，次のいずれかの条件を満たすこ
     と．
   (a) 再配布に伴うドキュメント（利用者マニュアルなど）に，上記の著
       作権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 再配布の形態を，別に定める方法によって，TOPPERSプロジェクトに
       報告すること．
 (4) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者およびTOPPERSプロジェクトを免責すること．
     また，本ソフトウェアのユーザまたはエンドユーザからのいかなる理
     由に基づく請求からも，上記著作権者およびTOPPERSプロジェクトを
     免責すること．
 
 本ソフトウェアは，無保証で提供されているものである．上記著作権者お
 よびTOPPERSプロジェクトは，本ソフトウェアに関して，特定の使用目的
 に対する適合性も含めて，いかなる保証も行わない．また，本ソフトウェ
 アの利用により直接的または間接的に生じたいかなる損害に関しても，そ
 の責任を負わない．
 
 $Id: target_user.txt 1799 2023-04-01 00:50:30Z ertl-komori $
----------------------------------------------------------------------

○目次

１．nRF5340-DKターゲット依存部の概要
	1.1 対応するターゲットシステムとターゲット略称
	1.2 ターゲット依存部の構成
	1.3 依存している個別パッケージのバージョン番号
	1.4 開発環境／デバッグ環境と動作確認条件
	1.5 メモリマップ
２．ターゲット定義事項の規定
３．ドライバ関連の情報
	3.1 タイマドライバ
	3.2 シリアルインタフェースドライバ
	3.3 システムログの低レベル出力
４．システム構築手順と実行手順
	4.1 ドライバのインストール
	4.2 プログラムの書き込み
	4.3 デバッグ
５．リファレンス
	5.1 ディレクトリ構成・ファイル構成
	5.2 バージョン履歴


１．nRF5340-DKターゲット依存部の概要

nRF5340-DKターゲット依存部（GNU開発環境向け）は，TOPPERS/ASP3カーネル
Nordic nRF5340を搭載したnRF5340-DKボード上で動作させる環境を構築する
ためのものである．nRF5340は2つのCPUコアApp core及びNet coreからなるAMP
構成となっているが，本ターゲット依存部ではApp coreでの実行のみをサポート
する．

1.1 対応するターゲットシステムとターゲット略称

nRF5340-DKターゲット依存部（GNU開発環境向け）の動作確認は，実機を用いて
行っている．nRF5340-DKに関する情報は，以下のウェブサイトにある．

	https://www.nordicsemi.com/Products/Development-hardware/nRF5340-DK

プログラムをフラッシュメモリに書き込んで実行する方法（ROM実行）のみを
サポートしている．

ターゲット略称等は次の通り．

	ターゲット略称：nrf5340_dk_gcc
	システム略称：nRF5340-DK
	開発環境略称：gcc

1.2 ターゲット依存部の構成

nRF5340-DKターゲット依存部（GNU開発環境向け）は，チップ依存部として
nrf5340チップ依存部（GNU開発環境向け）を，コア依存部としてARM_Mコア
依存部（GNU開発環境向け）を使用している．

ターゲット依存部（targetディレクトリ）およびターゲット依存部の共通部
（archディレクトリ）のディレクトリは次の通り．

	target/
		nrf5340_dk_gcc/		nRF5340-DKターゲット依存部

	arch/
		arm_m_gcc/common/	ARM_Mコア依存部
		arm_m_gcc/nrf5340/	nRF5340チップ依存部
		arm_m_gcc/doc/		ARM_M依存部に関するドキュメント
		gcc/				GCC開発環境依存部

1.3 依存している個別パッケージのバージョン番号

nRF5340-DKターゲット依存部（バージョン 3.7.0）の個別パッケージが
依存している個別パッケージと，動作確認を行ったバージョンは次の通り．

	個別パッケージの名称	バージョン	個別パッケージファイル名
	------------------------------------------------------------------
	ターゲット非依存部		3.7.0		asp3-3.7.0.tar.gz

1.4 開発環境／デバッグ環境と動作確認条件

開発環境として，以下のURLからプリビルド版をダウンロードすることができ
るGNU ARM Embedded Toolchainを用いている．

	https://developer.arm.com/open-source/gnu-toolchain/gnu-rm

動作確認を行ったバージョンは次の通り．

    gcc: 11.3.1 20220712
    binutils（objcopy，objdump）：2.38.20220708

1.5 メモリマップ

以下のメモリマップを想定している．

	0x00000000 - 0x00100000：内臓フラッシュメモリ（1MB）
	0x20000000 - 0x20080000：内蔵SRAM（512kB）
	0x40000000 - 0x41000000：I/O領域（16MB），予約領域を含む

メモリマップを変更する場合には，nrf5340_dk.ldを修正する必要がある．


２．ターゲット定義事項の規定

nRF5340-DKターゲット依存部は，ARM_Mコア依存部とnRF5340チップ
依存部を用いて実装されている．ARM_Mコア依存部およびnRF5340チップ
依存部におけるターゲット定義事項の規定については，「ARM_M依存部 
ユーザーズマニュアル」を参照すること．


３．ドライバ関連の情報

3.1 タイマドライバ

高分解能タイマは，nRF5340が持つ3チャンネルのTimer/counterの内
TIMER0を用いて実現している．

3.2 シリアルインタフェースドライバ

シリアルインタフェースドライバは，nRF5340が持つ4ポートのUARTインタ
フェースをサポートしている．

各ポートは，以下の通りに設定している．

	ボーレート：115200bps
	データ：8ビット
	パリティ：なし
	ストップビット：1ビット


3.3 システムログの低レベル出力

システムログの低レベル出力は，シリアルインタフェースドライバのポート1と
同じチャネルに対して，ポーリングにより文字を出力する方法で実現している．
シリアルインタフェースドライバのポート1はSafeG-Mが有効な場合にUART1，
無効な場合にUART2に接続される（下記参照）．

nRF5340-DKのUSBポートをPCに接続すると，3つの仮想COMポート（VCOM0,
VCOM1, VCOM2と呼称する）が利用できる．これらは以下のようにUARTペリ
フェラル及びGPIOに接続されている．

・VCOM0 : Net coreのUART0, TX(P1.01), RX(P1.00)
・VCOM1 : App coreのUART1, GPIOとは未接続
・VCOM2 : App coreのUART0, TX(P0.20), RX(P0.22)

App coreから利用できるVCOMはVCOM1，VCOM2のみである．またGPIOに接続
されているのはVCOM2だけであるため，デフォルトではVCOM2を使用する．
しかしながら，SafeG-Mを用いてゲストOSとしてZephyrを動作させた場合，
ZephyrもVCOM2を使用するため競合する．そのためSafeG-Mを有効にした際
はVCOM1を使用する．このとき，VCOM1とGPIOを適当な方法で接続する必要
がある．デフォルトではTXとしてP1.06，RXとしてP1.07を使用するため，
ボード上のP3とP24を以下のように接続する．

  P3  - P24
P1.06 - RxD
P1.07 - TxD

用いるポートを変更する場合には，nrf5340_dk.h, tSIOPortTarget.cdlを
修正する必要がある．またtarget_kernel_impl.cにおいてGPIOの設定を修正
する必要もある．


４．システム構築手順と実行手順

nRF5340用のASP3カーネルおよびサンプルプログラムを構築する手順は，
「TOPPERS/ASP3カーネル ユーザーズマニュアル」の「３．クイックス
タートガイド」の章に記述されている通りである．

4.1 ドライバのインストール

nRF5340-DKのUSBポートとPCを接続しても，nRF5340-DKがシリアル
ポートとして認識されない場合には，USBシリアルドライバをインストール
する必要がある．

Windows向けのドライバは，以下のURLにある．

	https://developer.mbed.org/handbook/Windows-serial-configuration

MacOS X用のUSBシリアルドライバは，例えば，以下のURLにあるものを使用する
ことができる．

	https://www.ftdichip.com/Drivers/VCP.htm

4.2 プログラムの書き込み

nrfjprogによる書き込みをサポートしている．nrfjprogにPATHが通っている環境
において`make run'と実行することにより書き込みが行える．

nrfjprogは以下のURLから入手できる．
https://www.nordicsemi.com/Products/Development-tools/nRF-Command-Line-Tools

4.3 デバッグ

JLink及びGDBを利用したデバッグ動作を確認している．以下のコマンドでJLinkに
よるGDBサーバが起動できる．GDBにより実行イメージasp.elfをロードし，ポート
2331に接続することでリモートデバッグが可能である．

$ JLinkGDBServer -device nRF5340_xxAA_APP -if SWD -speed auto -ir -nogui


５．リファレンス

5.1 ディレクトリ構成・ファイル構成

	target/nrf5340_dk_gcc/
		Makefile.target				Makefileのターゲット依存部
		nRF5340_dk.h				ターゲットのハードウェア資源の定義
		nrf5340_dk.ld				標準のリンカスクリプト
		tSIOPortTarget.cdl			シリアルインタフェースドライバのターゲット
									依存部（nRF5340-DK用）のコンポーネント記述
		target.cdl					コンポーネント記述ファイルのターゲット依存部
		target_cfg1_out.h			cfg1_out.cのリンクに必要なスタブの定義
		target_kernel.cfg			カーネル実装のコンフィギュレーションファイル
		target_kernel.h				kernel.hのターゲット依存部
		target_kernel.trb			kernel.trbのターゲット依存部
		target_check.trb			kernel_check.trbのターゲット依存部
		target_kernel_impl.c		カーネル実装のターゲット依存部
		target_kernel_impl.h		カーネル実装のターゲット依存部に関する定義
		target_rename.def			ターゲット依存部の内部識別名のリネーム定義
		target_rename.h				ターゲット依存部の内部識別名のリネーム
		target_sil.h				sil.hのターゲット依存部
		target_stddef.h				t_stddef.hのターゲット依存部
		target_syssvc.h				システムサービスのターゲット依存定義
		target_test.h				テストプログラムのターゲット依存定義
		target_timer.cfg			タイマドライバのコンフィギュレーションファイル
		target_timer.c				タイマドライバ実装のターゲット依存部
		target_timer.h				タイマドライバを使用するための定義
		target_unrename.h			ターゲット依存部の内部識別名のリネーム解除
		target_user.txt				ターゲット依存部のユーザーズマニュアル
		tSIOPortTargetMain_inline.h	シリアルインタフェースドライバのターゲット依存部

5.2 バージョン履歴

	2022年4月28日	Release	3.5.0		最初の一般公開
	2023年3月1日		Release 3.6.0
	2023年4月1日		Release 3.7.0

以上
